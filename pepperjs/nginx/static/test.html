<!DOCTYPE html>
<html>

<head>
  <title>Bulbaceous Balls</title>

  <script type="text/javascript">
	naclmod = null;  // Global application object.
	statusText = 'NO-STATUS';

	// Indicate success when the NaCl module has loaded.
	function moduleDidLoad() {
//      naclmod = document.getElementById('naclmod');
	  updateStatus('SUCCESS');
	  luasetup();
	}

	// Handle a message coming from the NaCl module.
	function handleMessage(message_event) {
		if( typeof(message_event.data)=='string' )
		{
			var s=message_event.data;
			var sn=s.indexOf('\n');
			var msg=s.substring(0,sn);
			var dat=s.substring(sn+1);
//          console.log(msg);
			if(msg=="cmd=print") // basic print command
			{
				console.log(dat);
			}
			else
			{
				console.log(s);
			}
		}
	}

	// If the page loads before the Native Client module loads, then set the
	// status message indicating that the module is still loading.  Otherwise,
	// do not change the status message.
	function pageDidLoad() {
	  if (naclmod == null) {
		updateStatus('LOADING...');
	  } else { updateStatus(); }
	}


	function luasetup() {
	  console.log("setup\n");
	  
			naclmod.postMessage('cmd=lua\n return require("wetgenes.win").nacl_start("swpaint.zip") ');

		var requestAnimationFrame = (function(){
	// it may be nice to use these, but they seem to degrade performance...
//        return  window.requestAnimationFrame       || 
//                window.webkitRequestAnimationFrame || 
//                window.mozRequestAnimationFrame    || 
//                window.oRequestAnimationFrame      || 
//                window.msRequestAnimationFrame     ||
return                function(callback,element){
					  window.setTimeout(callback, 1000 / 60);
				  };
		})();

		var update;      
			update=function() {
				requestAnimationFrame(update); // we need to always ask to be called again

	  naclmod.postMessage('cmd=lua\n return require("wetgenes.win").nacl_pulse() ');

			};
			update(); // start the updates
	}

	function updateStatus(opt_message) {
	  if (opt_message)
		statusText = opt_message;
	  var statusField = document.getElementById('statusField');
	  if (statusField) {
		statusField.innerHTML = statusText;
	  }
	  console.log(statusText);
	}


  </script>
</head>
<body onload="pageDidLoad()" style=" margin:0; padding:0; border:0; overflow:hidden;">

	<div id="listener" style=" width:100%; height:100%; position:absolute; ">
		<div id="naclmod" style=" width:100%; height:100%; position:absolute; ">
		</div>
		<script type="text/javascript" src="hg/bin/exe/gamecake.js"></script>
		<script type="text/javascript">
			var listener = document.getElementById('listener')
			naclmod = document.getElementById('naclmod')
			listener.addEventListener('load', moduleDidLoad, true);
			listener.addEventListener('message', handleMessage, true);
			CreateInstance(640, 480, naclmod );
			naclmod.finishLoading();
		</script>

	</div>

</body>
</html>
