<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>SWPAINT</title>

		<script src="js/jquery.min.js"></script>

		<script>
			
			console.log("OK");

naclmod = null;  // Global application object.
statusText = 'NO-STATUS';

// Indicate success when the NaCl module has loaded.
function moduleDidLoad(event) {
	$("#progress_nacl").attr("value",1);
  naclmod = document.getElementById('naclmod');
  updateStatus('SUCCESS');
  luasetup();
}

function moduleLoadProgress(event)
{
    var loadPercent = -1.0;
    if (event.lengthComputable && event.total > 0)
    {
		loadPercent = event.loaded / event.total * 100.0;
    }
	$("#progress_nacl").attr("value",loadPercent/100);
}


	function dec(s)
	{
		var s2="";
		if(s)
		{
			try
			{
				s2=s.split("%26").join("&").split("%3d").join("=").split("%25").join("%");
				return s2;
			}
			catch(e)
			{
				return "";
			}
		}
		return "";
	};
	
str_to_msg=function(s) // split a query like string
	{
	var i;
		var msg={};
		
		var aa=s.split("&");
		for(i in aa)
		{
		var v=aa[i];
			var va=v.split("=");
			msg[dec(va[0])]=dec(va[1]);
		}
		
		return msg;
	};
	
	
// Handle a message coming from the NaCl module.
function handleMessage(message_event) {
	if( typeof(message_event.data)=='string' )
	{
		var s=message_event.data;
		var sn=s.indexOf('\n');
		var msg=s.substring(0,sn);
		var dat=s.substring(sn+1);
//			console.log(msg);
		var m=str_to_msg(msg);
		if(m.cmd=="print") // basic print command
		{
			console.log(dat);
		}
		else
		if(m.cmd=="loading") // loading progress
		{
			$("#progress_zip").attr("value",Number(m.progress)/Number(m.total));
			if(m.progress==m.total)
			{
				$("#progress_nacl").hide();
				$("#progress_zip").hide();
			}
		}
		else
		{
			console.log(s);
		}
	}
}


function luasetup() {
	naclmod.postMessage(
		'cmd=lua\n'+
		'local win=require("wetgenes.win")\n'+
		'return win.\n'+
		'nacl_start({\n'+
		'zips={"swpaint.zip"},progress=function(t,p) win.js_post("cmd=loading&total="..t.."&progress="..p.."\\n") end\n'+
		'})\n');

	var requestAnimationFrame = function(callback,element){
				  window.setTimeout(callback, 1000 / 60);
			  };

	var update;      
		update=function() {
			requestAnimationFrame(update); // we need to always ask to be called again

  naclmod.postMessage('cmd=lua\n return require("wetgenes.win").nacl_pulse() ');

		};
		requestAnimationFrame(update); // start the updates
}

function updateStatus(opt_message) {
  if (opt_message)
	statusText = opt_message;
  var statusField = document.getElementById('statusField');
  if (statusField) {
	statusField.innerHTML = statusText;
  }
}


$(function(){

	console.log("Startin...");

	$('#listener')[0].addEventListener('load', moduleDidLoad,true);
	$('#listener')[0].addEventListener('message', handleMessage,true);
	$('#listener')[0].addEventListener('progress', moduleLoadProgress,true);
	
});

</script>

<script type="text/lua" id="swpaint_fetch_image">--<![CDATA[


--]]></script>

</head>

	<body style=" margin:0; padding:0; border:0; overflow:hidden;">

		<div id="listener" style=" width:50%; height:100%; position:absolute; left:0px;">
			<progress id="progress_nacl" value="0" style="width:45%" title="Loading NaCl"></progress>
			<progress id="progress_zip" value="0" style="width:45%" title="Loading Zip"></progress>
			<embed name="nacl_module"
				id="naclmod"
				src="bin/exe/gamecake.nmf"
				type="application/x-pnacl"
				style=" width:100%; height:100%; position:relative; "/>
		</div>

		<div id="side" style=" width:50%; height:100%; position:absolute; right:0px;">
		</div>

	</body>
</html>
