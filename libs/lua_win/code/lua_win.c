

#include "wet_types.h"

#include "lua.h"
#include "lauxlib.h"
#include "lualib.h"

#include "whereami.h"

#include <stdlib.h>



#include "SDL.h"

#include "../../lua_sdl2/luasdl2/src/window.h"

#if (defined __EMSCRIPTEN__)
#include "emscripten.h"
#endif


static const u8 font_bits[16*48]={

0x00,0x18,0x66,0x6c,0x18,0x00,0x70,0x18,0x0c,0x30,0x00,0x00,0x00,0x00,0x00,0x06,
0x00,0x18,0x66,0x6c,0x3e,0x66,0xd8,0x18,0x18,0x18,0xcc,0x30,0x00,0x00,0x00,0x0c,
0x00,0x18,0x00,0xfe,0x60,0xac,0xd0,0x00,0x30,0x0c,0x78,0x30,0x00,0x00,0x00,0x18,
0x00,0x18,0x00,0x6c,0x3c,0xd8,0x76,0x00,0x30,0x0c,0xfc,0xfc,0x00,0x7e,0x00,0x30,
0x00,0x18,0x00,0xfe,0x06,0x36,0xdc,0x00,0x30,0x0c,0x78,0x30,0x00,0x00,0x00,0x60,
0x00,0x00,0x00,0x6c,0x7c,0x6a,0xdc,0x00,0x18,0x18,0xcc,0x30,0x18,0x00,0x18,0xc0,
0x00,0x18,0x00,0x6c,0x18,0xcc,0x76,0x00,0x0c,0x30,0x00,0x00,0x18,0x00,0x18,0x80,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,

0x78,0x18,0x3c,0x3c,0x1c,0x7e,0x1c,0x7e,0x3c,0x3c,0x00,0x00,0x00,0x00,0x00,0x3c,
0xcc,0x38,0x66,0x66,0x3c,0x60,0x30,0x06,0x66,0x66,0x18,0x18,0x06,0x00,0x60,0x66,
0xdc,0x78,0x06,0x06,0x6c,0x7c,0x60,0x06,0x66,0x66,0x18,0x18,0x18,0x7e,0x18,0x06,
0xfc,0x18,0x0c,0x1c,0xcc,0x06,0x7c,0x0c,0x3c,0x3e,0x00,0x00,0x60,0x00,0x06,0x0c,
0xec,0x18,0x18,0x06,0xfe,0x06,0x66,0x18,0x66,0x06,0x00,0x00,0x18,0x7e,0x18,0x18,
0xcc,0x18,0x30,0x66,0x0c,0x66,0x66,0x18,0x66,0x0c,0x18,0x18,0x06,0x00,0x60,0x00,
0x78,0x18,0x7e,0x3c,0x0c,0x3c,0x3c,0x18,0x3c,0x38,0x18,0x18,0x00,0x00,0x00,0x18,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,

0x7c,0x3c,0x7c,0x1e,0x78,0x7e,0x7e,0x3c,0x66,0x3c,0x06,0xc6,0x60,0xc6,0xc6,0x3c,
0xc6,0x66,0x66,0x30,0x6c,0x60,0x60,0x66,0x66,0x18,0x06,0xcc,0x60,0xee,0xe6,0x66,
0xde,0x66,0x66,0x60,0x66,0x60,0x60,0x60,0x66,0x18,0x06,0xd8,0x60,0xfe,0xf6,0x66,
0xd6,0x7e,0x7c,0x60,0x66,0x78,0x78,0x6e,0x7e,0x18,0x06,0xf0,0x60,0xd6,0xde,0x66,
0xde,0x66,0x66,0x60,0x66,0x60,0x60,0x66,0x66,0x18,0x06,0xd8,0x60,0xc6,0xce,0x66,
0xc0,0x66,0x66,0x30,0x6c,0x60,0x60,0x66,0x66,0x18,0x66,0xcc,0x60,0xc6,0xc6,0x66,
0x78,0x66,0x7c,0x1e,0x78,0x7e,0x60,0x3e,0x66,0x3c,0x3c,0xc6,0x7e,0xc6,0xc6,0x3c,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

0x7c,0x3c,0x7c,0x3c,0x7e,0x66,0x66,0xc6,0xc6,0xc6,0x7e,0x3c,0x80,0x3c,0x00,0x00,
0x66,0x66,0x66,0x66,0x18,0x66,0x66,0xc6,0x6c,0x6c,0x0c,0x30,0xc0,0x0c,0x18,0x00,
0x66,0x66,0x66,0x70,0x18,0x66,0x66,0xc6,0x38,0x38,0x18,0x30,0x60,0x0c,0x66,0x00,
0x7c,0x66,0x7c,0x3c,0x18,0x66,0x66,0xd6,0x38,0x18,0x30,0x30,0x30,0x0c,0x00,0x00,
0x60,0x66,0x6c,0x0e,0x18,0x66,0x3c,0xfe,0x38,0x18,0x60,0x30,0x18,0x0c,0x00,0x00,
0x60,0x6e,0x66,0x66,0x18,0x66,0x3c,0xee,0x6c,0x18,0xc0,0x30,0x0c,0x0c,0x00,0x00,
0x60,0x3f,0x66,0x3c,0x18,0x3c,0x18,0xc6,0xc6,0x18,0xfe,0x3c,0x06,0x3c,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfe,

0x18,0x00,0x60,0x00,0x06,0x00,0x1c,0x00,0x60,0x18,0x0c,0x60,0x18,0x00,0x00,0x00,
0x18,0x00,0x60,0x00,0x06,0x00,0x30,0x00,0x60,0x00,0x00,0x60,0x18,0x00,0x00,0x00,
0x0c,0x3c,0x7c,0x3c,0x3e,0x3c,0x7c,0x3e,0x7c,0x18,0x0c,0x66,0x18,0xec,0x7c,0x3c,
0x00,0x06,0x66,0x60,0x66,0x66,0x30,0x66,0x66,0x18,0x0c,0x6c,0x18,0xfe,0x66,0x66,
0x00,0x3e,0x66,0x60,0x66,0x7e,0x30,0x66,0x66,0x18,0x0c,0x78,0x18,0xd6,0x66,0x66,
0x00,0x66,0x66,0x60,0x66,0x60,0x30,0x3e,0x66,0x18,0x0c,0x6c,0x18,0xc6,0x66,0x66,
0x00,0x3e,0x7c,0x3c,0x3e,0x3c,0x30,0x06,0x66,0x18,0x0c,0x66,0x0c,0xc6,0x66,0x3c,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3c,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x00,

0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x18,0x30,0xfe,0xff,
0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x1c,0x18,0x38,0x00,0xff,
0x7c,0x3e,0x7c,0x3c,0x7c,0x66,0x66,0xc6,0xc6,0x66,0x7e,0x18,0x18,0x18,0x00,0xff,
0x66,0x66,0x66,0x60,0x30,0x66,0x66,0xc6,0x6c,0x66,0x0c,0x38,0x18,0x1c,0x00,0xff,
0x66,0x66,0x60,0x3c,0x30,0x66,0x66,0xd6,0x38,0x66,0x18,0x38,0x18,0x1c,0x00,0xff,
0x7c,0x3e,0x60,0x06,0x30,0x66,0x3c,0xfe,0x6c,0x3c,0x30,0x18,0x18,0x18,0x00,0xff,
0x60,0x06,0x60,0x7c,0x1c,0x3e,0x18,0x6c,0xc6,0x18,0x7e,0x1c,0x18,0x38,0x00,0xff,
0x60,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x0c,0x18,0x30,0x00,0xff

};



/*+-----------------------------------------------------------------------------------------------------------------+*/
//
// draw a single char into an rgba bitmap and return this bitmap
//
// This gives us a very basic built in font to start with
//
/*+-----------------------------------------------------------------------------------------------------------------+*/
int lua_wetwin_glyph_8x8(lua_State *l)
{
const u8 *f=font_bits;
s32 x,y,xx,yy;
u8 m;
u8 b;
u32 c;

u32 bmap[8*8];

s32 id=0;

	id=(s32)(lua_tonumber(l,1));
	if( id<32 )  { id=32; }
	if( id>255 ) { id=255; }
	
	id=id-32;

	xx=(id%16);
	yy=(id/16);

// build a single char
	for(y=0;y<8;y++)
	{
		f=font_bits+((yy)*16*8)+(xx);
		for(x=0;x<8;x++)
		{
			b=*(f+(y*16));
			m=0x80>>x;
			if(b&m)
			{
				c=0xffffffff; // solid
			}
			else
			{
				c=0x00000000; // transparent
			}
			bmap[x+(y*8)]=c;
		}
	}
	
	lua_pushlstring(l,(const char *)bmap,4*8*8);

	return 1;
}


/*+-----------------------------------------------------------------------------------------------------------------+*/
//
// get path for exe
//
/*+-----------------------------------------------------------------------------------------------------------------+*/
int lua_wetwin_get_exe_path(lua_State *l)
{
int length;
char *path=0;

#if ! (defined __EMSCRIPTEN__)
	
	length=wai_getExecutablePath(NULL, 0, NULL);

	if(length>0)
	{
		path = (char*)malloc(length + 1);
	}

	if( path )
	{
		wai_getExecutablePath(path, length, NULL);
		path[length]='\0';
		
		lua_pushstring(l,path);
		
		free(path);

		return 1;
	}

#endif

	return 0;
}

/*+-----------------------------------------------------------------------------------------------------------------+*/
//
// get path for mod (parent of exe)
//
/*+-----------------------------------------------------------------------------------------------------------------+*/
int lua_wetwin_get_mod_path(lua_State *l)
{
int length;
char *path=0;
	
#if ! (defined __EMSCRIPTEN__)

	length=wai_getModulePath(NULL, 0, NULL);

	if(length>0)
	{
		path = (char*)malloc(length + 1);
	}

	if( path )
	{
		wai_getModulePath(path, length, NULL);
		path[length]='\0';
		
		lua_pushstring(l,path);
		
		free(path);

		return 1;
	}

#endif

	return 0;
}


/*+-----------------------------------------------------------------------------------------------------------------+*/
//
// attach resize hacks to an sdl window
//
/*+-----------------------------------------------------------------------------------------------------------------+*/

#define RESIZE_BORDER 8

static SDL_HitTestResult SDLCALL
	hitTest(SDL_Window *window, const SDL_Point *pt, void *data)
{
	int w, h;

//	bool IsFullscreen = SDL_GetWindowFlags(win) & FullscreenFlag;
//	if( IsFullscreen ) { return SDL_HITTEST_NORMAL; }
    
	SDL_GetWindowSize(window, &w, &h);

	if( pt->x <     RESIZE_BORDER  &&  pt->y <     RESIZE_BORDER ) { return SDL_HITTEST_RESIZE_TOPLEFT;     } else
	if( pt->x > w - RESIZE_BORDER  &&  pt->y <     RESIZE_BORDER ) { return SDL_HITTEST_RESIZE_TOPRIGHT;    } else
	if( pt->x > w - RESIZE_BORDER  &&  pt->y > h - RESIZE_BORDER ) { return SDL_HITTEST_RESIZE_BOTTOMRIGHT; } else
	if( pt->x <     RESIZE_BORDER  &&  pt->y > h - RESIZE_BORDER ) { return SDL_HITTEST_RESIZE_BOTTOMLEFT;  } else
//	if( pt->y <     RESIZE_BORDER                                ) { return SDL_HITTEST_RESIZE_TOP;         } else
	if( pt->y > h - RESIZE_BORDER                                ) { return SDL_HITTEST_RESIZE_BOTTOM;      } else
	if( pt->x <     RESIZE_BORDER                                ) { return SDL_HITTEST_RESIZE_LEFT;        } else
	if( pt->x > w - RESIZE_BORDER                                ) { return SDL_HITTEST_RESIZE_RIGHT;       } else
	if( pt->y <     RESIZE_BORDER                                ) { return SDL_HITTEST_DRAGGABLE;          }

	return SDL_HITTEST_NORMAL;
}



int lua_wetwin_sdl_attach_resize_hax(lua_State *l)
{
	SDL_Window *win = commonGetAs(l, 1, WindowName, SDL_Window *);
	
	SDL_SetWindowHitTest(win, hitTest, NULL);

	return 0;
}




extern void main_update ();
int lua_set_main_loop(lua_State *l)
{
#if (defined __EMSCRIPTEN__)

	emscripten_set_main_loop( main_update , 0 , 0 );

#endif
	return 0;
}


/*+-----------------------------------------------------------------------------------------------------------------

handle clipboard through javascript hacks

+-----------------------------------------------------------------------------------------------------------------+*/

#if (defined __EMSCRIPTEN__)

int lua_emcc_has_clipboard(lua_State *l)
{
	lua_pushboolean(l,1); // just say yes always
	return 1;
}


EM_JS(void, lua_emcc_set_clipboard_js, (const char* data), {
	var s0=UTF8ToString(data);
	Module.gamecake.set_clipboard(s0);
});

int lua_emcc_set_clipboard(lua_State *l)
{
	lua_emcc_set_clipboard_js( lua_tostring(l,1) );
	return 0;
}

EM_JS(char*, lua_emcc_get_clipboard_js, (), {
	var jsString = Module.gamecake.get_clipboard();
	var lengthBytes = lengthBytesUTF8(jsString)+1;
	var stringOnWasmHeap = _malloc(lengthBytes);
	stringToUTF8(jsString, stringOnWasmHeap, lengthBytes);
	return stringOnWasmHeap;
});

int lua_emcc_get_clipboard(lua_State *l)
{
	char *s=lua_emcc_get_clipboard_js();
	lua_pushstring(l,s);
	free(s);
	return 1;
}

#endif



/*+-----------------------------------------------------------------------------------------------------------------

Eval a javascript string and return a possible string value from that function

+-----------------------------------------------------------------------------------------------------------------+*/
#if (defined __EMSCRIPTEN__)

int lua_emcc_js_eval(lua_State *l)
{
const char *eval=0;
const char *result=0;

	eval=lua_tostring(l,1);

	result=emscripten_run_script_string(eval);
	
	if(result)
	{
		lua_pushstring(l,result);
//		free((void*)result);
	}

	return 1;
}
#endif


/*+-----------------------------------------------------------------------------------------------------------------+*/
//
// open library.
//
/*+-----------------------------------------------------------------------------------------------------------------+*/
LUALIB_API int luaopen_wetgenes_win_core(lua_State *l)
{
	const luaL_Reg lib[] =
	{
		{"set_main_loop",			lua_set_main_loop},

		{"glyph_8x8",			lua_wetwin_glyph_8x8},

// find ourselves

		{"get_exe_path",		lua_wetwin_get_exe_path},
		{"get_mod_path",		lua_wetwin_get_mod_path},

// sdl hax

		{"sdl_attach_resize_hax",		lua_wetwin_sdl_attach_resize_hax},
		
#if (defined __EMSCRIPTEN__)
		{	"has_clipboard",				lua_emcc_has_clipboard				},
		{	"set_clipboard",				lua_emcc_set_clipboard				},
		{	"get_clipboard",				lua_emcc_get_clipboard				},
		{	"js_eval",						lua_emcc_js_eval					},
#endif
		{0,0}
	};


	lua_newtable(l);
	luaL_openlib(l, NULL, lib, 0);
	
	return 1;
}

#if ! (defined __EMSCRIPTEN__)

#include "whereami.c"

#endif


